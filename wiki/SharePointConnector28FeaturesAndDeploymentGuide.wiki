#summary SharePoint connector 2.8 features and deployment guide
#labels Phase-Deploy

== Introduction ==

SharePoint connector 2.8 now supports LDAP (simple and nested) and SharePoint local groups resolution during serve time authentication. This is a step by step guide to deploy the connector to use this new feature.


=== How it works? ===

1. Connector is configured to feed ACLs using "Feed ACLs" flag available on the connector configuration page. Feeding ACLs to GSA using connector works with both Content and meta-URL feed mode. However, customers who want to use the SharePoint local groups at serve time must use the connector in content feed mode (authorization by connector). In metadata-URL feed mode, connector will feed the ACLs to GSA, but will not be able to resolve SharePoint local group during serve time authentication.

2. Connector feeds ACLs in the index to GSA along with SharePoint URLs.

3. Connector authentication rule is set in the security manager for the connector configured in step 1 ( under Serving -> Universal Login auth mechanisms)

4. For other authentication mechanisms in GSA (HTTP NTLM, LDAP, Kerberos, SAML), connector is configured to do group resolution only (steps differ as per GSA version. Details given below)

5. At serve time authentication, connector returns all the LDAP (simple and nested) and SharePoint local groups associated with the logged on user. This will work only when connector is using content feed mode.

6. authorization checker of GSA checks whether the listed User/group is part of the ACLs in the index. If any one match is found, authorization succeeds and the results are shown to the user.


===Mandatory Pre-requisites for feeding ACL using the connector===

1. Connector manager version 2.8. Download the connector 2.8 installer from http://code.google.com/p/googlesearchapplianceconnectors/downloads/list


2. Google services for SharePoint v2.8 should be installed on each SharePoint web front end in the farm. If the GSARKS installer is not available, You can manually deploy the Google Services for SharePoint using the manual deployment steps at 
http://code.google.com/p/google-enterprise-connector-sharepoint/wiki/ManualInstallation#Installing_Google_Services_for. 


3. A Valid SharePoint Site collection top level URL should be available in your SharePoint server

4. Valid Domain name (mandatory for Kerberos/NTLM based sites), Username and Password for the Site collection administrator (recommended) or any user in the Site collection with minimum Contribute permissions. These credentials will also be used to query your Active Directory. Make sure that this is a valid domain name in you active directory domain.

  
5. LDAP Server Host name or IP

 
6. LDAP Server port number. Typical value for non-SSL Active Directory Server: 389


7. LDAP search base. This will be the search base of your active directory under which all the expected LDAP Users and groups entries reside. Typical value for yourdomain.com: DC=yourdomain,DC=com


*Note:* LDAP parameters will get disabled if you do not choose to feed ACLs from SharePoint. This means LDAP parameters will make sense only if connector is feeding ACLs to GSA.

===Security and SharePoint 2.8 connector===

Connector support for group resolution during authentication depends on GSA version:

|| *Authentication* || * GSA 6.10 or earlier* || * GSA 6.12 * || * Username Format## * ||
|| LDAP || NO* || YES || username ||
|| HTTP NTLM || YES || YES || username ||
|| Connector || YES || YES || username ||
|| Kerberos || No# || YES || username ||
|| Windows SAML Bridge || No# || YES || username for SAML Bridge 2.8### ||


*Notes:*

# In GSA 6.10, Kerberos/SAML authentication doesn't request connector authentication for group lookup. LDAP is out of security manager in 6.10, so it will also not query connector for group lookup.

## Username format in ACL to be configured in the connector

### SAML Bridge 2.8 is available as a downloadable binary at http://code.google.com/p/google-saml-bridge-for-windows/downloads/list 

Apart from configuring the correct authentication mechanism on GSA, you need to select option for connector to do group lookup. In GSA 6.12 and above, if you want the connector to lookup a user's group information without performing authentication, check Perform group lookup only. Connector will rely on other authentication mechanism for authentication and do group resolution only. In GSA 6.10, select the option "Lookup a user's group information during Authentication whenever possible." for supporting group resolution. In GSA 6.10, you must use HTTP based NTLM or connector authentication for group resolution to work. This means that any silent authentication mechanism like SAML or Kerberos will not support group resolution by connector.

Connector supports following authorization mechanisms on GSA:

1. Head request (Meta-URL feeds only)

2. SAML authorization (Meta-URL feeds only)

3. Connector authorization (Content feeds only)

4. ACLs in the index (both feed modes)

5. Policy ACLs under Access Control (both feed modes)

==User data store==

By default, connector uses H2 database for storing user data information in the SharePoint. User datastore has a mapping of SharePoint local groups and LDAP group with the SharePoint sites. If you want to configure an external database for Use data store, use the following steps. Note that the External database used for configuring User Data Store must support UTF-8 characters if the user/group names use UTF-8 characters. It is recommended to use internal H2 database only as it does not require any additional steps.

=== Steps to configure external data base for User Data Store: ===

*Step1:* Copy connector jar to Tomcat-home/webapps/connector-manager/WEB-INF/lib

*Step2:* Start the tomcat server to explode connector-manager directory under Tomcat-home/webapps/

*Step3:* Open the applicationContext.properties file by browsing to Tomcat-home/webapps/connector-manager/WEB-INF/ and click to edit

*Step4:* Un comment the below lines as per the data base you plan to configure for User Data Store.

* For MySQL: *

dbc.datasource.type=mysql

jdbc.datasource.mysql.url=jdbc:mysql://myserver/google_connectors

jdbc.datasource.mysql.user=username

jdbc.datasource.mysql.password=<encrypted password>

*For Oracle:*

dbc.datasource.type=oracle

jdbc.datasource.oracle.url=jdbc:mysql://myserver/google_connectors

jdbc.datasource.oracle.user=username

jdbc.datasource.oracle.password=encrypted password

*For MS SQL Server:*

dbc.datasource.type=mssql

jdbc.datasource.mssql.url=jdbc:mysql://myserver/google_connectors

jdbc.datasource.mssql.user=username

jdbc.datasource.mssql.password=encrypted password

Refer connector-manager wiki page http://code.google.com/p/google-enterprise-connector-manager/wiki/EncryptPassword to encrypt password.

*Step3:* After copying encrypt password copy below mentioned driver libraries to Tomcat-home/webapps/connector-manager/WEB-INF/lib.

*Step4:* Start connector service/ Tomcat to configure connector on GSA.

*Note:* We have certified the connector with all below mentioned drivers.

*MYSQL:* mysql-connector-java-5.1.6-bin.jar

*MS SQL server:* sqljdbc.jar

*Oracle:* ojdbc14.jar


=== Removing User datastore from the Database ===

When connector instance is deleted, you must also remove the user datastore to avoid stale tables on your database. Use the attached SQL script to drop the User data store tables from your DB.

*1. For H2 in-memory database:*

Install H2 console application by downloading the windows installer using below link.
http://www.h2database.com/h2-setup-2011-05-27.exe
Please refer the attached screen-shot (H2 console application) for installing and browsing H2 data base and follow the steps.
Open the SQL script that you downloaded from the SharePoint connector source zip file and then copy to SQL command area and then click on run to delete User data store related tables and index.

*2. For MYSQL :*

Browse to User data store schema using MYSQL query browser.
Open the SQL script that you downloaded from the SharePoint connector source zip file and copy the two commands to SQL command area and then click on execute to delete User data store related tables and index.

*3. For MS-SQL:*

Browse to User data store schema using MSSQL query browser.
Open the SQL script that you downloaded from the SharePoint connector source zip file and copy the two commands to SQL command area and then click on execute to delete User data store related tables and index.

*4. For Oracle:*

Browse to User data store schema using SQL prompt or TOAD.
Open the SQL script that you downloaded from the SharePoint connector source zip file and copy the two commands to SQL command area and then click on execute to delete User data store related tables and index.




===SharePoint connector 2.8 FAQ===

*Q1. Does SharePoint connector 2.8 utilize the built-in database of the CM at all in this release?

A:   SP connector 2.8 uses built-in H2 DB to store the nested group data by default.

*Q2. Will the installer 2.8 provide upgrade option from 2.6.8 to 2.8 for SharePoint connector?

A:   Installer 2.8 will provide option for upgrading the connector from 2.6.8 to 2.8. It will also upgrade connector manager from 2.6.6 to 2.8.

*Q3. For SharePoint connector, does the installer have to be used to create DB schema for the user/group database?

A:   Required tables are created at run-time while configuring the connector instance from the admin console. There are no tables pre-configured while installing.

*Q4. The check box: "Append Namespace to SharePoint group in ACL" - is there a reason this would need to be unchecked?

A:   At the moment this is the only way to differentiate the group names in connector across different site collections in SharePoint. It can be unchecked if we configure the connector to crawl single site collection.

*Q5. User group cache size: is it in-memory? What's the meaning of cache size? Why is refresh needed?

A:   Yes it is in memory and cache size refers to initial size of the cache and by default its size would be 1000. This means that connector will be able to keep 1000 search users ->(resolved AD groups + local SP groups) entries in the cache. For the next incoming search user (1001), cache service will automatically remove the very first old entry from the cache. This is how connector will accommodate the next search user entry (along with resolved AD groups + SP groups) in the cache. Approximately 120 KB would be the size of the cache, if the cache consist of 10 entries.






















